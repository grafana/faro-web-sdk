const { readFileSync, writeFileSync } = require('node:fs');
const { join } = require('node:path');

if (process.env['SKIP_GEN_VERSION'] && process.env['SKIP_GEN_VERSION'] === '1') {
  console.info('Skipping generating version file due to "SKIP_GEN_VERSION" environment variable');
  process.exit(0);
}

let version = '';

try {
  const packageJson = JSON.parse(readFileSync(join(process.cwd(), 'package.json'), 'utf8'));
  version = packageJson.version;

  if (!version) {
    throw new Error('No version found in package.json');
  }
} catch (err) {
  console.error('Could not generate version file');
  console.error(err);
  process.exit(1);
}

writeFileSync(
  'src/version.ts',
  `// auto-generated by bin/genVersion.ts
export const VERSION = '${version}';
`
);
